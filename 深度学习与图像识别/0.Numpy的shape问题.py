#%%
# -*- coding UTF-8 -*-
'''
@Project : MyProjects
@File : 0.Numpyçš„shapeé—®é¢˜.py
@Author : chenbei
@Date : 2021/7/21 9:47
'''
import matplotlib.pyplot as plt
from matplotlib.pylab import mpl

plt.rcParams['font.sans-serif'] = ['Times New Roman']  # è®¾ç½®å­—ä½“é£æ ¼,å¿…é¡»åœ¨å‰ç„¶åè®¾ç½®æ˜¾ç¤ºä¸­æ–‡
mpl.rcParams['font.size'] = 10.5  # å›¾ç‰‡å­—ä½“å¤§å°
mpl.rcParams['font.sans-serif'] = ['SimHei']  # æ˜¾ç¤ºä¸­æ–‡çš„å‘½ä»¤
mpl.rcParams['axes.unicode_minus'] = False  # æ˜¾ç¤ºè´Ÿå·çš„å‘½ä»¤
mpl.rcParams['agg.path.chunksize'] = 10000
plt.rcParams['figure.figsize'] = (7.8, 3.8)  # è®¾ç½®figure_sizeå°ºå¯¸
plt.rcParams['savefig.dpi'] = 600  # å›¾ç‰‡åƒç´ 
plt.rcParams['figure.dpi'] = 600  # åˆ†è¾¨ç‡
from matplotlib.font_manager import FontProperties

font_set = FontProperties(fname=r"C:\Windows\Fonts\simsun.ttc", size=10.5)
import numpy as np
import pandas as pd
import tensorflow as tf
# input_shape : ç¬¬ä¸€å±‚(é»„è‰²ä¸è®¡å…¥),ç„¶åä»ç¬¬äºŒå±‚åˆ°å†…å±‚è®¡ç®—æ¯å±‚æœ‰å‡ ä¸ªä¸‹ä¸€å±‚,æœ€åä¸ºå…ƒç´ çš„ä¸ªæ•°
# ç‰¹åˆ«è¯´æ˜çš„æ˜¯: åŒä¸€å±‚æ¯ä¸ªç»„æ‹¥æœ‰çš„ä¸‹ä¸€å±‚ç»„æ•°å¿…é¡»ç›¸åŒ
# input_dim : ä»£è¡¨å¼ é‡çš„é˜¶æ•°,çœ‹æœ‰å‡ å±‚æ‹¬å· ä¾‹å­å½“ä¸­é˜¶æ•°ä¸º4
# 1é˜¶ç»¿è‰²3å±‚ã€2é˜¶æµ…è“è‰²2å±‚ã€3é˜¶æ·±è“è‰²5å±‚ã€4é˜¶å…ƒç´ ä¸ªæ•°3ä¸ª
# ç‰¹åˆ«çš„å¯¹äºå‘é‡è€Œè¨€,é˜¶æ•°çš„å«ä¹‰é€€åŒ–æˆäº†ç»´åº¦,ä¾‹å¦‚æŒ‡å®šinput_dim=32å®é™…ä¸Šæ˜¯ä¸€ä¸ª32ä¸ªå…ƒç´ /ç»´åº¦çš„å‘é‡,ä½†æ˜¯ä¸€ä¸ªä¸€é˜¶å¼ é‡(32,)
# 4ä¸ªä¸­æ‹¬å·+1ä¸ªå°æ‹¬å· ä¸­æ‹¬å·å±‚æ•°=ç»´åº¦æ•°
# æ ‡é‡Scalar shape=()) D=0
# å‘é‡Vector shape=(n,) D=1 å…ƒç´ é•¿åº¦n
# çŸ©é˜µMatrix shape=(n,n) D=2 n*n
# å¼ é‡Tensor shape=(h,w,c) D>2 ç»Ÿç§°å¼ é‡ or (b,h,w,c)
a = np.array([  # 3ä¸ªç»¿è‰²å±‚ shape={tuple:4} (3,2,5,3)
    [   # ç»¿è‰²å±‚1 ä¸‹æ–¹æœ‰2ä¸ªæµ…è“è‰²å±‚,æ¯ä¸ªæµ…è“è‰²å±‚æœ‰5ä¸ªæ·±è“å±‚,å¹¶å¸¦æœ‰3ä¸ªå…ƒç´ 
        [
            [1,3,4],[2,4,5],[5,6,7],[3,5,3],[5,3,2] # æµ…è“è‰²å±‚1çš„æ·±è“è‰²æœ‰5å±‚ å…ƒç´ 3ä¸ª
        ],
        [
            [1,3,4],[3,4,5],[1,3,4],[4,5,6],[3,5,3] # æµ…è“è‰²å±‚2çš„æ·±è“è‰²å±‚å¿…é¡»ä¹Ÿæ˜¯5å±‚ä¸”å…ƒç´ 3ä¸ª å¦åˆ™éœ€è¦dtype=object
        ]
    ],
    [
        [
            [1, 3, 4], [2, 4, 5], [5, 6, 7], [3, 5, 3], [5, 3, 2]
        ],
        [
            [1, 3, 4], [3, 4, 5], [1, 3, 4], [4, 5, 6], [3, 5, 3]
        ]
    ],
    [
        [
            [1, 3, 4], [2, 4, 5], [5, 6, 7], [3, 5, 3], [5, 3, 2]
        ],
        [
            [1, 3, 4], [3, 4, 5], [1, 3, 4], [4, 5, 6], [3, 5, 3]
        ]
    ]
])
#%% ã€ç´¢å¼•ã€‘
x = tf.random.normal([4,32,32,3]) # 4ä¸ªä¸­æ‹¬å·
x[0] # è®¿é—®ç¬¬ä¸€å¼ å›¾ç‰‡ shape=(32, 32, 3)
# å–ç¬¬ 1 å¼ å›¾ç‰‡çš„ç¬¬ 2 è¡Œ
x[0][1] # shape=(32, 3) æœ‰32ä¸ªé•¿åº¦ä¸º3çš„å‘é‡
x[0][1][-1] # shape=(3,) é•¿åº¦ä¸º3çš„å‘é‡
# å–ç¬¬ 2 å¼ å›¾ç‰‡ï¼Œç¬¬ 10 è¡Œï¼Œç¬¬ 3 åˆ—
x[1,9,2]
#%% ã€åˆ‡ç‰‡ã€‘
# ğ‘ ğ‘¡ğ‘ğ‘Ÿğ‘¡: ğ‘’ğ‘›ğ‘‘: ğ‘ ğ‘¡ğ‘’ğ‘åˆ‡ç‰‡
x[1:3] # è¯»å–ç¬¬ 2,3 å¼ å›¾ç‰‡
x[:,0:28:2,0:28:2,:] # ç¤ºå–æ‰€æœ‰å›¾ç‰‡ï¼Œéš”è¡Œé‡‡æ ·ï¼Œéš”åˆ—é‡‡æ ·ï¼Œæ‰€æœ‰é€šé“ä¿¡æ¯ é«˜å®½ç¼©æ”¾50%
x[0,::] # è¯»å–ç¬¬ 1 å¼ å›¾ç‰‡çš„æ‰€æœ‰è¡Œ
#%% ã€ç»´åº¦ç›¸åŠ ã€‘
z = tf.random.normal([4,2]) # çŸ©é˜µshape=(4,2) 4ä¸ªæ ·æœ¬
b = tf.ones([2]) # å‘é‡[0,0] shape=(2,) è‡ªåŠ¨ç”Ÿæˆ4ä¸ªç›¸åŒåç½® æ ·æœ¬å…±äº«
out = z + b # å¯ä»¥ç›¸åŠ  bå¤åˆ¶æ¬¡æ•°ç­‰äºæ ·æœ¬æ•° bæŒ‰è¡Œå åŠ 
print(z.numpy(),out.numpy())
print(z.shape,out.shape)
# åˆ›å»ºä¸€å±‚ Wx+bï¼Œè¾“å‡ºèŠ‚ç‚¹ä¸º 3
fc = tf.keras.layers.Dense(3)
# é€šè¿‡ build å‡½æ•°åˆ›å»º W,b å¼ é‡ï¼Œè¾“å…¥èŠ‚ç‚¹ä¸º 4
fc.build(input_shape=(2,4)) # [last_dim, self.units]  2ä¸ªæ ·æœ¬é•¿åº¦ä¸º4
# ç±»çš„åç½®æˆå‘˜ bias åˆå§‹åŒ–ä¸ºå…¨ 0ï¼Œè¿™ä¹Ÿæ˜¯åç½®ğ’ƒçš„é»˜è®¤åˆå§‹åŒ–æ–¹æ¡ˆ
# fc.bias # åç½®å‘é‡ b çš„é•¿åº¦åº”ä¸º 3
fc.kernel # shape=(4, 3)
# x@w+b ç½‘ç»œå±‚ç§°ä¸ºçº¿æ€§å±‚
x = tf.random.normal([2,4]) # 2ä¸ªæ ·æœ¬
w = tf.ones([4,3]) # å®šä¹‰ W å¼ é‡
b = tf.zeros([3]) # å®šä¹‰ b å¼ é‡
o = x@w+b # X@W+b è¿ç®—
#%% ã€reshapeã€‘
# åŸºæœ¬çš„ç»´åº¦å˜æ¢åŒ…å«äº†æ”¹å˜è§†å›¾ reshapeï¼Œæ’å…¥æ–°ç»´åº¦ expand_dimsï¼Œåˆ é™¤ç»´åº¦
# squeezeï¼Œäº¤æ¢ç»´åº¦ transposeï¼Œå¤åˆ¶æ•°æ® tile ç­‰
x = tf.range(96) # shape=(96,) D=1
x=tf.reshape(x,[2,4,4,3]) # shape=(2, 4, 4, 3) D=4
y = tf.reshape(x,[2,-1]) # å‚æ•°-1 è¡¨ç¤ºå½“å‰è½´ä¸Šé•¿åº¦éœ€è¦æ ¹æ®è§†å›¾æ€»å…ƒç´ ä¸å˜çš„æ³•åˆ™è‡ªåŠ¨æ¨å¯¼
y.ndim,y.shape # (2, TensorShape([2, 48]))
#%% ã€expand_dimsã€squeezeã€‘
x = tf.random.uniform([28,28],maxval=10,dtype=tf.int32)
print(tf.expand_dims(x,axis=2).shape) # (28, 28, 1)
print(tf.expand_dims(x,axis=1).shape) # (28, 1, 28)
print(tf.expand_dims(x,axis=0).shape) # (1, 28, 28)
y = tf.random.uniform([1,28,28,1],maxval=10,dtype=tf.int32)
print(tf.squeeze(y).shape)# (28, 28) ä¸æŒ‡å®šç»´åº¦å‚æ•°axisé»˜è®¤åˆ é™¤æ‰€æœ‰é•¿åº¦ä¸º 1 çš„ç»´åº¦
#%% ã€transposeã€‘
# æ”¹å˜è§†å›¾ã€å¢åˆ ç»´åº¦éƒ½ä¸ä¼šå½±å“å¼ é‡çš„å­˜å‚¨
# ä½†äº¤æ¢ç»´åº¦å¯ä»¥æ”¹å˜å¼ é‡çš„å­˜å‚¨é¡ºåºï¼ŒåŒæ—¶æ”¹å˜å¼ é‡çš„è§†å›¾
# å®Œæˆç»´åº¦äº¤æ¢åï¼Œå¼ é‡çš„å­˜å‚¨é¡ºåºå·²ç»æ”¹å˜
# åç»­çš„æ‰€æœ‰æ“ä½œå¿…é¡»åŸºäºæ–°çš„å­˜ç»­é¡ºåºè¿›è¡Œ
# éƒ¨åˆ†åº“çš„å›¾ç‰‡æ ¼å¼æ˜¯é€šé“å…ˆè¡Œ [ğ‘, â„, w, ğ‘] ----> [ğ‘, ğ‘, â„, w]
x = tf.random.normal([2,32,32,3])
# æ–°ç»´åº¦çš„æ’åºä¸ºå›¾ç‰‡æ•°é‡ã€é€šé“æ•°ã€è¡Œã€åˆ—ï¼Œå¯¹åº”çš„ç´¢å¼•å·ä¸º[0,3,1,2]
print(tf.transpose(x,perm=[0,3,1,2]).shape)
#%% ã€tileå¤åˆ¶æ•°æ®ã€‘
# é€šè¿‡å¢åŠ ç»´åº¦æ“ä½œæ’å…¥æ–°ç»´åº¦åï¼Œå¯èƒ½å¸Œæœ›åœ¨æ–°çš„ç»´åº¦ä¸Šé¢å¤åˆ¶è‹¥å¹²ä»½æ•°æ®
# è€ƒè™‘ğ‘Œ = ğ‘‹@ğ‘Š + ğ’ƒçš„ä¾‹å­ï¼Œåç½®ğ’ƒæ’å…¥æ–°ç»´åº¦åï¼Œéœ€è¦åœ¨æ–°ç»´åº¦ä¸Šå¤åˆ¶ batch size ä»½æ•°æ®
input = tf.random.normal([2,4])
w = tf.ones([4,3]) # å®šä¹‰ W å¼ é‡
# è¾“å…¥2ä¸ªæ ·æœ¬ æ•…åç½®bä¹Ÿåº”å½“æœ‰2ä¸ª è¾“å‡ºèŠ‚ç‚¹3 æ•…bé•¿åº¦3
b = tf.constant([1.,2.]) # D=1 shape=(2,)
print(b.shape)
b = tf.expand_dims(b,axis=1) # D=2 shape=(2, 1)
print(b.shape)
b = tf.tile(b,multiples=[1,3]) # D=3 shape=(2, 3)
print(b.shape)
print(b.numpy()) # [[1 1 1],[2 2 2]]
output = input@w+b
print(output.shape) # shape=(2, 3)
output = tf.tile(output,multiples=[2,1])
print(output.shape) # shape=(4, 3) æ³¨æ„æ˜¯å…¨éƒ¨æˆå€å¤åˆ¶
#%% ã€Broadcastingã€‘
# tf.tile ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¼ é‡æ¥ä¿å­˜å¤åˆ¶åçš„å¼ é‡ è®¡ç®—ä»£ä»·é«˜
# Broadcasting æ“ä½œ å«å¹¿æ’­æœºåˆ¶ è½»é‡çº§å¼ é‡å¤åˆ¶çš„æ‰‹æ®µ
# Broadcasting æœºåˆ¶éƒ½èƒ½é€šè¿‡ä¼˜åŒ–æ‰‹æ®µé¿å…å®é™…å¤åˆ¶æ•°æ®è€Œå®Œæˆé€»è¾‘è¿ç®—
# Broadcasting çš„æ•ˆæœå’Œ tf.tile ä¸€æ ·ï¼Œéƒ½èƒ½åœ¨æ­¤ç»´åº¦ä¸Šé€»è¾‘å¤åˆ¶æ•°æ®è‹¥å¹²ä»½ ä½†æ˜¯ä¸æ˜¯çœŸçš„å¤åˆ¶æ•°æ®
input = tf.random.normal([2,4])
w = tf.ones([4,3])
b = tf.constant([1.,2.])
b = tf.expand_dims(b,axis=1) # æ‹“å±•ç»´åº¦,ç»´åº¦ä¿æŒä¸€è‡´æ—¶çœç•¥äº†æ•°æ®å¤åˆ¶æ“ä½œ
# output = input@w+b # ä¹Ÿå¯ä»¥ç›´æ¥ç›¸åŠ  åˆ©ç”¨å¹¿æ’­æ•ˆåº”
# ç­‰ä»·äº output = input@w + tf.broadcast_to(b,[2,3])
output = input@w + tf.broadcast_to(b,shape=[2,3])
print(output.shape) # shape=(2, 3)
# ä¸‹æ–¹æ¡ˆä¾‹å±•ç¤ºäº†å¦‚ä½•ä»[w,1]--->æ‹“å±•åˆ°[b,h,w,c]
# é¦–å…ˆé»˜è®¤å³å¯¹é½è¿›è¡Œæ‰©å±•
A = tf.constant([1,2]) # (2,)
A = tf.expand_dims(A,axis=1) # (2,1)
A = tf.tile(A,multiples=[2,1]) # (4,1)
print(A.numpy()) # [ [1] [2] [1] [2] ]
B = tf.broadcast_to(A, [2,4,4,3]) # cç»´åº¦æ‰©å±•3ä»½ ç„¶ååœ¨bã€wç»§ç»­å¤åˆ¶
print(B[0]) # 4ä¸ª4Ã—3çš„çŸ©é˜µ [ [ [1] [2] [1] [2] ] , [ [1] [2] [1] [2] ] , [ [1] [2] [1] [2] ]]
#%% ã€matualã€‘çŸ©é˜µç›¸ä¹˜ ç»´åº¦D>2æ—¶ ä¼šåªè®¡ç®—æœ€å2ä¸ªç»´åº¦
a = tf.random.normal([4,3,23,32])
b = tf.random.normal([4,3,32,2])
print((a@b).shape) # (4, 3, 23, 2)
# çŸ©é˜µç›¸ä¹˜å‡½æ•°æ”¯æŒè‡ªåŠ¨ Broadcasting æœºåˆ¶
a = tf.random.normal([4,28,32])
b = tf.random.normal([32,16]) # ä¼šè‡ªåŠ¨å¹¿æ’­åˆ°[4,32,16]
print((a@b).shape) # (4, 28, 16)
